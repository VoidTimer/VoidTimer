<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="Images/Image1.png">
    <link rel="stylesheet" href="TimerCSS.css?v=1.0">
    <title>Magical Countdown</title>
    <style>
        
    </style>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="magic-mist"></div>
    <div class="magic-glow" id="magicGlow"></div>
    <div id="runes"></div>
    
    <div class="main-container">
        <div class="date-picker-container">
            <h3 class="date-picker-title">Set Your Target Date</h3>
            <input type="date" id="targetDatePicker" class="date-picker">
            <button onclick="setCustomDate()" class="date-button">Set Date</button>
            <button onclick="resetToDefault()" class="date-button date-button-secondary">Reset to Oct 20</button>
            <div id="dateStatus" class="date-status"></div>
        </div>
        
        <div class="countdown-container">
            <div class="countdown-title">Countdown</div>
            <div class="countdown" id="countdown">
                <!-- JS will populate here -->
            </div>
            
            <!-- SMS Reminder Form -->
            <div class="sms-reminder-container">
                <h3 class="sms-title">Get Weekly SMS Updates</h3>
                <p class="sms-description">Receive weekly countdown updates every Sunday at 12:00 PM</p>
                <div class="sms-form">
                    <input type="tel" id="phoneNumber" placeholder="Enter your phone number" class="phone-input">
                    <button onclick="subscribeToWeeklyReminders()" class="sms-button">Subscribe to Weekly Updates</button>
                    <button onclick="unsubscribeFromReminders()" class="sms-button sms-button-secondary">Unsubscribe</button>
                </div>
                <div id="smsStatus" class="sms-status"></div>
            </div>
        </div>
    </div>
    <script>
        // Global variable to store the target date
        let targetDate = new Date(new Date().getFullYear(), 9, 20, 0, 0, 0, 0); // Default: October 20th
        
        // Load custom date from localStorage on page load
        function loadCustomDate() {
            const savedDate = localStorage.getItem('customTargetDate');
            console.log('Loading custom date from localStorage:', savedDate);
            
            if (savedDate) {
                targetDate = new Date(savedDate);
                document.getElementById('targetDatePicker').value = targetDate.toISOString().split('T')[0];
                showDateStatus('Custom date loaded', 'info');
                console.log('Custom date loaded:', targetDate);
                // Update countdown immediately to reflect the loaded date
                updateCountdown();
            } else {
                // Check if default October 20th has passed this year
                const now = new Date();
                const currentYear = now.getFullYear();
                const defaultDate = new Date(currentYear, 9, 20, 0, 0, 0, 0);
                
                // If October 20th has passed this year, set it for next year
                if (now > defaultDate) {
                    targetDate = new Date(currentYear + 1, 9, 20, 0, 0, 0, 0);
                }
                
                console.log('Using default date:', targetDate);
                // Set default date in the date picker
                document.getElementById('targetDatePicker').value = targetDate.toISOString().split('T')[0];
            }
        }
        
        // Set custom target date
        function setCustomDate() {
            const dateInput = document.getElementById('targetDatePicker').value;
            if (!dateInput) {
                showDateStatus('Please select a date', 'error');
                return;
            }
            
            const selectedDate = new Date(dateInput + 'T00:00:00');
            const now = new Date();
            
            if (selectedDate <= now) {
                showDateStatus('Please select a future date', 'error');
                return;
            }
            
            targetDate = selectedDate;
            localStorage.setItem('customTargetDate', targetDate.toISOString());
            console.log('Custom date saved to localStorage:', targetDate.toISOString());
            showDateStatus('Target date updated successfully!', 'success');
            
            // Update countdown immediately
            updateCountdown();
        }
        
        // Reset to default October 20th date
        function resetToDefault() {
            const currentYear = new Date().getFullYear();
            const defaultDate = new Date(currentYear, 9, 20, 0, 0, 0, 0);
            const now = new Date();
            
            // If October 20th has passed this year, set it for next year
            if (now > defaultDate) {
                defaultDate.setFullYear(currentYear + 1);
            }
            
            targetDate = defaultDate;
            document.getElementById('targetDatePicker').value = targetDate.toISOString().split('T')[0];
            localStorage.removeItem('customTargetDate');
            showDateStatus('Reset to default October 20th date', 'success');
            
            // Update countdown immediately
            updateCountdown();
        }
        
        // Show date status messages
        function showDateStatus(message, type) {
            const statusDiv = document.getElementById('dateStatus');
            statusDiv.textContent = message;
            statusDiv.className = `date-status ${type}`;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'date-status';
            }, 3000);
        }
        
        // Countdown logic (updated to use global targetDate)
        function updateCountdown() {
            const now = new Date();
            const diff = targetDate - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            const seconds = Math.floor((diff / 1000) % 60);
            document.getElementById('countdown').innerHTML = `
                <div class="countdown-segment">
                    <span class="countdown-number">${days}</span>
                    <span class="countdown-label">Days</span>
                </div>
                <div class="countdown-segment">
                    <span class="countdown-number">${hours}</span>
                    <span class="countdown-label">Hours</span>
                </div>
                <div class="countdown-segment">
                    <span class="countdown-number">${minutes}</span>
                    <span class="countdown-label">Minutes</span>
                </div>
                <div class="countdown-segment">
                    <span class="countdown-number">${seconds}</span>
                    <span class="countdown-label">Seconds</span>
                </div>
            `;
        }
        
        // Initialize countdown - moved to window.onload to ensure date is loaded first
        function initializeCountdown() {
            setInterval(updateCountdown, 1000);
            updateCountdown();
        }

        // Magical sparkles
        function createSparkle() {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            const size = Math.random() * 8 + 4;
            sparkle.style.width = `${size}px`;
            sparkle.style.height = `${size}px`;
            sparkle.style.left = `${Math.random() * 100}%`;
            sparkle.style.top = `${Math.random() * 100}%`;
            sparkle.style.background = `radial-gradient(circle, #fff 0%, #a259ff 60%, transparent 100%)`;
            sparkle.style.filter = `blur(${Math.random() * 2}px)`;
            sparkle.style.animationDuration = `${2 + Math.random() * 2}s`;
            document.getElementById('magicGlow').appendChild(sparkle);
            setTimeout(() => sparkle.remove(), 4000);
        }
        setInterval(createSparkle, 180);

        // Animated glowing runes
        const runes = ['\u16B1', '\u16D6', '\u16C1', '\u16B7', '\u16DA', '\u16C7', '\u16CB', '\u16D2', '\u16C4', '\u16C8'];
        function placeRunes() {
            const runeContainer = document.getElementById('runes');
            runeContainer.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const rune = document.createElement('div');
                rune.className = 'rune';
                rune.textContent = String.fromCharCode(parseInt(runes[Math.floor(Math.random()*runes.length)].replace('\\u',''),16));
                rune.style.left = `${10 + Math.random()*80}%`;
                rune.style.top = `${5 + Math.random()*90}%`;
                rune.style.fontSize = `${2 + Math.random()*3}rem`;
                rune.style.transform = `rotate(${Math.random()*360}deg)`;
                runeContainer.appendChild(rune);
            }
        }
        placeRunes();
        setInterval(placeRunes, 6000);

        // Background Music Auto-Play
        function initializeMusic() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            backgroundMusic.volume = 0.3; // Set to comfortable volume level
            
            // Attempt to play music automatically
            backgroundMusic.play().catch((error) => {
                // If autoplay fails (browser policy), try again on first user interaction
                console.log('Autoplay blocked, will try on first user interaction');
                document.addEventListener('click', function() {
                    backgroundMusic.play().catch(() => {
                        console.log('Music playback failed');
                    });
                }, { once: true });
            });
        }

        // SMS Weekly Reminder Functionality
        function subscribeToWeeklyReminders() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const statusDiv = document.getElementById('smsStatus');
            
            // Validate phone number
            if (!phoneNumber || !isValidPhoneNumber(phoneNumber)) {
                showStatus('Please enter a valid phone number', 'error');
                return;
            }
            
            // Use the current target date (which can be custom or default)
            const now = new Date();
            if (targetDate <= now) {
                showStatus('Cannot subscribe to reminders for a date that has already passed', 'error');
                return;
            }
            
            // Calculate next Sunday at 12:00 PM
            const nextSunday = getNextSunday();
            
            // Store subscription in localStorage
            const subscription = {
                phoneNumber: phoneNumber,
                subscribed: true,
                subscribedDate: now.getTime(),
                targetDate: targetDate.getTime(),
                nextReminderDate: nextSunday.getTime()
            };
            
            localStorage.setItem('weeklyReminderSubscription', JSON.stringify(subscription));
            
            // Set up the weekly reminder check
            setupWeeklyReminderCheck();
            
            const targetDateStr = targetDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            showStatus(`Successfully subscribed! You'll receive weekly updates every Sunday at 12:00 PM until ${targetDateStr}`, 'success');
            
            // Send immediate confirmation SMS
            sendWelcomeSMS(phoneNumber, targetDateStr);
        }
        
        function unsubscribeFromReminders() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!phoneNumber || !isValidPhoneNumber(phoneNumber)) {
                showStatus('Please enter your phone number to unsubscribe', 'error');
                return;
            }
            
            // Check if subscription exists
            const subscription = JSON.parse(localStorage.getItem('weeklyReminderSubscription') || 'null');
            if (!subscription || subscription.phoneNumber !== phoneNumber) {
                showStatus('No active subscription found for this phone number', 'error');
                return;
            }
            
            // Remove subscription
            localStorage.removeItem('weeklyReminderSubscription');
            showStatus('Successfully unsubscribed from weekly reminders', 'success');
            
            // Send unsubscribe confirmation SMS
            sendUnsubscribeSMS(phoneNumber);
        }
        
        function getNextSunday() {
            const now = new Date();
            const nextSunday = new Date(now);
            const daysUntilSunday = (7 - now.getDay()) % 7;
            
            // If today is Sunday and it's before 12 PM, use today
            if (now.getDay() === 0 && now.getHours() < 12) {
                nextSunday.setHours(12, 0, 0, 0);
            } else {
                // Otherwise, get next Sunday
                nextSunday.setDate(now.getDate() + (daysUntilSunday === 0 ? 7 : daysUntilSunday));
                nextSunday.setHours(12, 0, 0, 0);
            }
            
            return nextSunday;
        }
        
        function setupWeeklyReminderCheck() {
            // Check every hour if it's time to send weekly reminder
            setInterval(checkWeeklyReminder, 3600000); // Check every hour
            checkWeeklyReminder(); // Check immediately
        }
        
        function checkWeeklyReminder() {
            const subscription = JSON.parse(localStorage.getItem('weeklyReminderSubscription') || 'null');
            if (!subscription || !subscription.subscribed) return;
            
            const now = new Date().getTime();
            const reminderTime = subscription.nextReminderDate;
            
            // If it's time for the weekly reminder (within 1 hour window)
            if (now >= reminderTime && now <= reminderTime + 3600000) {
                sendWeeklyReminderSMS(subscription);
                
                // Schedule next week's reminder
                const nextWeek = new Date(reminderTime + (7 * 24 * 60 * 60 * 1000));
                subscription.nextReminderDate = nextWeek.getTime();
                localStorage.setItem('weeklyReminderSubscription', JSON.stringify(subscription));
            }
        }
        
        function sendWelcomeSMS(phoneNumber, targetDateStr) {
            const message = `🎃 Welcome to Wi.Bi Studios Magical Countdown! You'll receive weekly updates every Sunday at 12 PM until ${targetDateStr}. Reply STOP to unsubscribe. ✨`;
            
            sendSMSMessage(phoneNumber, message, 'Welcome message sent!');
        }
        
        function sendUnsubscribeSMS(phoneNumber) {
            const message = `🎃 You've been unsubscribed from Wi.Bi Studios Magical Countdown updates. Thanks for being part of our magical journey! ✨`;
            
            sendSMSMessage(phoneNumber, message, 'Unsubscribe confirmation sent!');
        }
        
        function sendWeeklyReminderSMS(subscription) {
            const targetDate = new Date(subscription.targetDate);
            const now = new Date();
            const timeDiff = targetDate - now;
            
            const targetDateStr = targetDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Check if the event has passed
            if (timeDiff <= 0) {
                // Event has passed, send final message and unsubscribe
                const message = `🎃 The magical moment has arrived! ${targetDateStr} is here! Thanks for following our countdown journey. ✨🎉`;
                sendSMSMessage(subscription.phoneNumber, message, 'Final countdown message sent!');
                
                // Auto-unsubscribe after event
                localStorage.removeItem('weeklyReminderSubscription');
                return;
            }
            
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff / (1000 * 60 * 60)) % 24);
            const weeks = Math.floor(days / 7);
            const remainingDays = days % 7;
            
            let timeLeftMessage;
            if (weeks > 0) {
                if (remainingDays > 0) {
                    timeLeftMessage = `${weeks} week${weeks > 1 ? 's' : ''} and ${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
                } else {
                    timeLeftMessage = `${weeks} week${weeks > 1 ? 's' : ''}`;
                }
            } else if (days > 0) {
                timeLeftMessage = `${days} day${days > 1 ? 's' : ''} and ${hours} hour${hours > 1 ? 's' : ''}`;
            } else {
                timeLeftMessage = `${hours} hour${hours > 1 ? 's' : ''}`;
            }
            
            const weekNumber = Math.ceil((new Date() - new Date(subscription.subscribedDate)) / (7 * 24 * 60 * 60 * 1000));
            const message = `🎃 Weekly Countdown Update #${weekNumber}: Only ${timeLeftMessage} left until ${targetDateStr}! The magic is building! ✨ Reply STOP to unsubscribe.`;
            
            sendSMSMessage(subscription.phoneNumber, message, 'Weekly reminder sent!');
        }
        
        function sendSMSMessage(phoneNumber, message, successMessage) {
            // Send SMS via backend
            fetch('send-sms.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phoneNumber: phoneNumber,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('SMS sent successfully:', data);
                    if (successMessage) {
                        showStatus(successMessage, 'success');
                    }
                } else {
                    console.error('SMS sending failed:', data);
                    showStatus('Failed to send SMS', 'error');
                }
            })
            .catch(error => {
                console.error('Error sending SMS:', error);
                // Fallback: show alert if backend is not available
                alert(`SMS would be sent to ${phoneNumber}: ${message}`);
                console.log('SMS Message:', {
                    to: phoneNumber,
                    message: message
                });
            });
        }
        
        function isValidPhoneNumber(phone) {
            // Basic phone number validation
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            return phoneRegex.test(cleanPhone) && cleanPhone.length >= 10;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('smsStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sms-status ${type}`;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'sms-status';
            }, 5000);
        }
        
        function setupReminderCheck() {
            // Check every minute if it's time to send reminder
            setInterval(checkReminder, 60000);
            checkReminder(); // Check immediately
        }
        
        function checkReminder() {
            const reminder = JSON.parse(localStorage.getItem('smsReminder') || 'null');
            if (!reminder) return;
            
            const now = new Date().getTime();
            const reminderTime = reminder.reminderTime;
            
            // If it's time for the reminder (within 1 minute window)
            if (now >= reminderTime && now <= reminderTime + 60000) {
                sendSMSReminder(reminder);
                // Remove the reminder after sending
                localStorage.removeItem('smsReminder');
            }
        }
        
        function sendSMSReminder(reminder) {
            const targetDate = new Date(reminder.targetDate);
            const now = new Date();
            const timeDiff = targetDate - now;
            
            const targetDateStr = targetDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((timeDiff / (1000 * 60)) % 60);
            
            let timeLeftMessage;
            if (days > 0) {
                timeLeftMessage = `${days} day${days > 1 ? 's' : ''}, ${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minute${minutes > 1 ? 's' : ''}`;
            } else if (hours > 0) {
                timeLeftMessage = `${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minute${minutes > 1 ? 's' : ''}`;
            } else {
                timeLeftMessage = `${minutes} minute${minutes > 1 ? 's' : ''}`;
            }
            
            const message = `🎃 Magical Countdown Reminder! Only ${timeLeftMessage} left until ${targetDateStr}! ✨`;
            
            // Send SMS via backend
            fetch('send-sms.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phoneNumber: reminder.phoneNumber,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('SMS sent successfully:', data);
                    showStatus('SMS reminder sent successfully!', 'success');
                } else {
                    console.error('SMS sending failed:', data);
                    showStatus('Failed to send SMS reminder', 'error');
                }
            })
            .catch(error => {
                console.error('Error sending SMS:', error);
                // Fallback: show alert if backend is not available
                alert(`SMS would be sent to ${reminder.phoneNumber}: ${message}`);
                console.log('SMS Reminder:', {
                    to: reminder.phoneNumber,
                    message: message,
                    timeLeft: timeLeftMessage
                });
            });
        }
        
        // Check for existing weekly subscription on page load
        window.onload = function() {
            // Initialize custom date picker FIRST
            loadCustomDate();
            
            // Initialize countdown AFTER date is loaded
            initializeCountdown();
            
            // Initialize music system
            initializeMusic();
            
            // Handle existing subscription
            const subscription = JSON.parse(localStorage.getItem('weeklyReminderSubscription') || 'null');
            if (subscription && subscription.subscribed) {
                setupWeeklyReminderCheck();
                const nextReminderDate = new Date(subscription.nextReminderDate);
                if (nextReminderDate > new Date()) {
                    document.getElementById('phoneNumber').value = subscription.phoneNumber;
                    showStatus(`Subscribed to weekly updates! Next reminder: ${nextReminderDate.toLocaleDateString()} at ${nextReminderDate.toLocaleTimeString()}`, 'info');
                }
            }
        };
    </script>
</body>
</html>
